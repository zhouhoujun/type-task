!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("tslib"),require("@ts-ioc/core"),require("@ts-ioc/aop"),require("rxjs/BehaviorSubject"),require("rxjs/add/operator/filter"),require("@ts-ioc/logs")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core","@ts-ioc/aop","rxjs/BehaviorSubject","rxjs/add/operator/filter","@ts-ioc/logs"],e):(t.core=t.core||{},t.core.umd=t.core.umd||{},t.core.umd.js=e(t.tslib_1,t.core_1,t.aop_1,t.BehaviorSubject_1,t.filter,t.logs_1))}(this,function(c,l,r,i,t,o){"use strict";c=c&&c.hasOwnProperty("default")?c.default:c,l=l&&l.hasOwnProperty("default")?l.default:l,r=r&&r.hasOwnProperty("default")?r.default:r,i=i&&i.hasOwnProperty("default")?i.default:i,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o;"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}var a=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TaskContainerToken=new l.InjectToken("__TASK_TaskContainer")});e(a);a.TaskContainerToken;var s=n(function(t,e){t.exports=function(d,f){function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function e(t,e){return t(e={exports:{}},e.exports),e.exports}d=d&&d.hasOwnProperty("default")?d.default:d,f=f&&f.hasOwnProperty("default")?f.default:f;var n=e(function(t,e){function n(t,e,n,r){return f.createClassDecorator(t,function(t){n&&n(t)},function(t){return r&&(t=r(t)),e&&!t.annotationBuilder&&(t.annotationBuilder=e),t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createAnnotationDecorator=n,e.Annotation=n("Annotation")});t(n),n.createAnnotationDecorator,n.Annotation;var o=e(function(t,e){function n(n,r,i,e,o){return f.createClassDecorator(n,function(t){e&&e(t)},function(t){if(o&&(t=o(t)),!t.name&&f.isClass(t.type)){var e=/^[a-z]$/.test(t.type.name);e&&t.type.classAnnations?t.name=t.type.classAnnations.name:t.name=t.type.name}return t.decorType=n,r&&!t.builder&&(t.builder=r),i&&!t.annotationBuilder&&(t.annotationBuilder=i),t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createDIModuleDecorator=n,e.DIModule=n("DIModule")});t(o),o.createDIModuleDecorator,o.DIModule;var r=e(function(t,e){function n(t,e,n,r,i){return o.createDIModuleDecorator(t,e,n,r,function(e){return i&&i(e),setTimeout(function(){var t=e.builder;(f.isClass(t)?f.isFunction(t.create)?t.create():new t:t).bootstrap(e.type)},800),e})}Object.defineProperty(e,"__esModule",{value:!0}),e.createBootstrapDecorator=n,e.Bootstrap=n("Bootstrap")});t(r),r.createBootstrapDecorator,r.Bootstrap;var i=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),d.__exportStar(n,e),d.__exportStar(o,e),d.__exportStar(r,e)});t(i);var a=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.AppConfigureToken=new f.InjectToken("DI_APP_Configuration")});t(a),a.AppConfigureToken;var s=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"DI_ModuleBuilder",t)||this}return d.__extends(t,e),t.classAnnations={name:"InjectModuleBuilder",params:{constructor:["desc"]}},t}(f.Registration);e.InjectModuleBuilder=n,e.ModuleBuilderToken=new n("")});t(s),s.InjectModuleBuilder,s.ModuleBuilderToken;var u=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container,e=t.get(f.LifeScopeToken);e.registerDecorator(i.DIModule,f.CoreActions.bindProvider,f.CoreActions.cache,f.CoreActions.componentBeforeInit,f.CoreActions.componentInit,f.CoreActions.componentAfterInit),e.registerDecorator(i.Bootstrap,f.CoreActions.bindProvider,f.CoreActions.cache,f.CoreActions.componentBeforeInit,f.CoreActions.componentInit,f.CoreActions.componentAfterInit),t.register(c.ModuleBuilder),t.register(y.DefaultApplicationBuilder)},t.classAnnations={name:"BootModule",params:{constructor:["container"],setup:[]}},t=d.__decorate([f.IocExt("setup"),d.__param(0,f.Inject(f.ContainerToken)),d.__metadata("design:paramtypes",[Object])],t)}();e.BootModule=n});t(u),u.BootModule;var l=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.classAnnations={name:"LoadedModule",params:{}},t}();e.LoadedModule=n});t(l),l.LoadedModule;var p=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"DI_TypeBuilder",t)||this}return d.__extends(t,e),t.classAnnations={name:"InjectAnnotationBuilder",params:{constructor:["desc"]}},t}(f.Registration);e.InjectAnnotationBuilder=n,e.AnnotationBuilderToken=new n("")});t(p),p.InjectAnnotationBuilder,p.AnnotationBuilderToken;var h=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}var e;return(e=t).prototype.build=function(r,i,o){return d.__awaiter(this,void 0,void 0,function(){var e,n;return d.__generator(this,function(t){switch(t.label){case 0:return i||(i=this.getTokenMetaConfig(r)),(e=this.getBuilder(i))===this?[3,1]:[2,e.build(r,i,o)];case 1:return[4,this.createInstance(r,i,o)];case 2:return n=t.sent(),[4,this.buildStrategy(n,i)];case 3:return[2,n=t.sent()]}})})},t.prototype.buildByConfig=function(n,r){return d.__awaiter(this,void 0,void 0,function(){var e;return d.__generator(this,function(t){return f.isToken(n)?(e=n,[2,this.build(e,this.getTokenMetaConfig(e),r)]):(e=this.getBootstrapToken(n),[2,this.build(e,this.getTokenMetaConfig(e,n),r)])})})},t.prototype.createInstance=function(e,t,n){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(t){if(!e)throw new Error("cant not find bootstrap token.");if(!this.container.has(e)){if(!f.isClass(e))return console.log("cant not find token "+e.toString()+" in container."),[2,null];this.container.register(e)}return[2,this.resolveToken(e,n)]})})},t.prototype.getBuilder=function(t){if(t&&t.annotationBuilder){if(f.isClass(t.annotationBuilder)&&(this.container.has(t.annotationBuilder)||this.container.register(t.annotationBuilder)),f.isToken(t.annotationBuilder))return this.container.resolve(t.annotationBuilder);if(t.annotationBuilder instanceof e)return t.annotationBuilder}return this},t.prototype.buildStrategy=function(e,t){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(t){return[2,e]})})},t.prototype.getBootstrapToken=function(t){return t.bootstrap},t.prototype.getTokenMetaConfig=function(t,e){var n;if(f.isClass(t))n=this.getMetaConfig(t);else if(f.isToken(t)){var r=this.container?this.container.getTokenImpl(t):t;f.isClass(r)&&(n=this.getMetaConfig(r))}return n?f.lang.assign({},n,e||{}):e||{}},t.prototype.getDecorator=function(){return i.Annotation.toString()},t.prototype.getMetaConfig=function(t){var e=this.getDecorator();if(f.hasOwnClassMetadata(e,t)){var n=f.getTypeMetadata(e,t);if(n&&n.length)return n[0]}return null},t.prototype.resolveToken=function(t,e){return this.container.resolve(t,e)},t.classAnnations={name:"AnnotationBuilder",params:{constructor:[],build:["token","config","data"],buildByConfig:["config","data"],createInstance:["token","config","data"],getBuilder:["config"],buildStrategy:["instance","config"],getBootstrapToken:["config"],getTokenMetaConfig:["token","config"],getDecorator:[],getMetaConfig:["token"],resolveToken:["token","data"]}},d.__decorate([f.Inject(f.ContainerToken),d.__metadata("design:type",Object)],t.prototype,"container",void 0),t=e=d.__decorate([f.Singleton(p.AnnotationBuilderToken),d.__metadata("design:paramtypes",[])],t)}();e.AnnotationBuilder=n});t(h),h.AnnotationBuilder;var v=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){this.pools=new f.MapSet}return t.prototype.getTokenKey=function(t){return t instanceof f.Registration?t.toString():t},t.prototype.isDefault=function(t){return t===this.defaults},t.prototype.hasDefault=function(){return!!this.defaults},t.prototype.setDefault=function(t){this.defaults=t},t.prototype.getDefault=function(){return this.defaults},t.prototype.set=function(t,e){this.getTokenKey(t),this.pools.has(t)&&console.log(t.toString()+" module has loaded"),this.pools.set(t,e)},t.prototype.get=function(t){var e=this.getTokenKey(t);return this.has(e)?this.pools.get(t):null},t.prototype.has=function(t){return this.pools.has(this.getTokenKey(t))},t.classAnnations={name:"ContainerPool",params:{constructor:[],getTokenKey:["token"],isDefault:["container"],hasDefault:[],setDefault:["container"],getDefault:[],set:["token","container"],get:["token"],has:["token"]}},t}();e.ContainerPool=n,e.ContainerPoolToken=new f.InjectToken("ContainerPool"),e.containerPools=new n});t(v),v.ContainerPool,v.ContainerPoolToken,v.containerPools;var c=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var a="__exportProviders",c=function(e){function t(t){return e.call(this,t,"module_loader")||this}return d.__extends(t,e),t.classAnnations={name:"InjectModuleLoadToken",params:{constructor:["token"]}},t}(f.Registration);e.InjectModuleLoadToken=c;var n=function(){function t(){}var r;return(r=t).prototype.getPools=function(){return this.pools||(this.pools=v.containerPools),this.pools.hasDefault()||this.regDefaultContainer(),this.pools},t.prototype.setPools=function(t){this.pools=t},t.prototype.regDefaultContainer=function(){var t=this.createContainer();return t.register(u.BootModule),this.pools.setDefault(t),t},t.prototype.getContainer=function(t,e,n){var r,i=this.getPools();if(f.isToken(t)){if(i.has(t))return i.get(t);var o=this.getConfigure(t,e);return(r=o.container||e)||(r=this.isDIModule(t)?this.createContainer():i.getDefault()),this.setParent(r,n),i.set(t,r),r}return t.name&&i.has(t.name)?i.get(t.name):(r=t.container?t.container:t.container=e||i.getDefault(),t.name&&i.set(t.name,r),this.setParent(r,n),r)},t.prototype.setParent=function(t,e){var n=this.getPools();n.isDefault(t)||t.parent||(t.parent=e&&e!==t?e:n.getDefault())},t.prototype.createContainer=function(){return this.getContainerBuilder().create()},t.prototype.getContainerBuilder=function(){return this.containerBuilder||(this.containerBuilder=this.createContainerBuilder()),this.containerBuilder},t.prototype.createContainerBuilder=function(){return new f.DefaultContainerBuilder},t.prototype.load=function(a,s,u){return d.__awaiter(this,void 0,void 0,function(){var e,n,r,i,o;return d.__generator(this,function(t){switch(t.label){case 0:return e=this.getContainer(a,s,u),n=f.isToken(a)?a:a.name,r=new c(n),f.isToken(r)&&e.has(r)?[2,e.resolve(r)]:(i=this.getConfigure(a,e),[4,this.registerDepdences(e,i)]);case 1:return i=t.sent(),o={moduleToken:f.isToken(a)?a:null,container:e,moduleConfig:i},n&&e.bindProvider(r,function(){return o}),[2,o]}})})},t.prototype.build=function(u,c,l){return d.__awaiter(this,void 0,void 0,function(){var e,n,r,i,o,a,s;return d.__generator(this,function(t){switch(t.label){case 0:return[4,this.loadByDefaults(u,c)];case 1:return e=t.sent(),n=e.container,r=e.moduleConfig,(i=this.getBuilder(n,r))&&i!==this?[4,i.build(u,n,l)]:[3,3];case 2:return[2,t.sent()];case 3:return(o=e.moduleToken)?[3,5]:[4,this.getTypeBuilder(n,r.annotationBuilder).buildByConfig(r,l)];case 4:return[2,a=t.sent()];case 5:return[4,this.getTypeBuilder(n,r.annotationBuilder).build(o,r,l)];case 6:return a=t.sent(),s=a,f.isFunction(s.mdOnInit)&&s.mdOnInit(e),[2,a]}})})},t.prototype.bootstrap=function(a,s,u){return d.__awaiter(this,void 0,void 0,function(){var e,n,r,i,o;return d.__generator(this,function(t){switch(t.label){case 0:return[4,this.loadByDefaults(a,s)];case 1:return e=t.sent(),n=e.moduleConfig,(r=this.getBuilder(e.container,n))&&r!==this?[4,r.bootstrap(a,e,u)]:[3,3];case 2:return[2,t.sent()];case 3:return[4,this.build(a,e,u)];case 4:return i=t.sent(),o=void 0,e.moduleToken?(i&&f.isFunction(i.anBeforeCreate)&&i.anBeforeCreate(e),[4,this.getTypeBuilder(e.container,n.annotationBuilder).buildByConfig(n,u)]):[3,8];case 5:return o=t.sent(),f.isFunction(i.anAfterCreate)&&i.anAfterCreate(o),f.isFunction(i.mdOnStart)?[4,Promise.resolve(i.mdOnStart(o))]:[3,7];case 6:t.sent(),t.label=7;case 7:return f.isFunction(i.mdOnStarted)&&i.mdOnStarted(o),[3,9];case 8:o=i,t.label=9;case 9:return[2,o]}})})},t.prototype.loadByDefaults=function(n,r){return d.__awaiter(this,void 0,void 0,function(){var e;return d.__generator(this,function(t){switch(t.label){case 0:return r instanceof l.LoadedModule?(e=r,[3,3]):[3,1];case 1:return[4,this.load(n,r)];case 2:e=t.sent(),t.label=3;case 3:return[2,e]}})})},t.prototype.getBuilder=function(t,e){var n;return f.isClass(e.builder)&&(t.has(e.builder)||t.register(e.builder)),f.isToken(e.builder)?n=t.resolve(e.builder):e.builder instanceof r&&(n=e.builder),n},t.prototype.getTypeBuilder=function(t,e){var n;return f.isClass(e)&&(t.has(e)||t.register(e)),f.isToken(e)?n=t.resolve(e):e instanceof h.AnnotationBuilder&&(n=e),n||(n=this.getDefaultTypeBuilder(t)),n},t.prototype.getDefaultTypeBuilder=function(t){return t.resolve(p.AnnotationBuilderToken)},t.prototype.importModule=function(n,r){return d.__awaiter(this,void 0,void 0,function(){var e;return d.__generator(this,function(t){switch(t.label){case 0:return r&&f.isClass(n)&&!this.isDIModule(n)?(r.register(n),[2,r]):[4,this.load(n,null,r)];case 1:return e=t.sent(),r.has(e.moduleToken)?[3,3]:[4,this.importConfigExports(r,e.container,e.moduleConfig)];case 2:t.sent(),e.container.parent=r,e.moduleToken&&r.bindProvider(e.moduleToken,e),t.label=3;case 3:return[2,r]}})})},t.prototype.getDecorator=function(){return i.DIModule.toString()},t.prototype.getConfigure=function(t,e){var n;if(f.isClass(t))n=this.getMetaConfig(t);else if(f.isToken(t)){var r=e?e.getTokenImpl(t):t;f.isClass(r)&&(n=this.getMetaConfig(r))}else{n=t;var i=this.getBootstrapToken(n);if(i){var o=f.isClass(i)?i:e?e.getTokenImpl(i):i;f.isClass(o)&&(n=f.lang.assign({},this.getMetaConfig(o),n||{}))}}return n||{}},t.prototype.registerDepdences=function(e,n){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(t){switch(t.label){case 0:return[4,this.registerExts(e,n)];case 1:return t.sent(),[4,this.registerConfgureDepds(e,n)];case 2:return[2,n=t.sent()]}})})},t.prototype.getBootstrapToken=function(t){return t.bootstrap},t.prototype.importConfigExports=function(i,o,n){return d.__awaiter(this,void 0,void 0,function(){var e,r=this;return d.__generator(this,function(t){switch(t.label){case 0:return n.exports&&n.exports.length?[4,Promise.all(n.exports.map(function(n){return d.__awaiter(r,void 0,void 0,function(){return d.__generator(this,function(t){return i.bindProvider(n,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return o.resolve.apply(o,[n].concat(t))}),[2,n]})})}))]:[3,2];case 1:t.sent(),t.label=2;case 2:return(e=n[a])&&e.length&&e.forEach(function(t){i.bindProvider(t,function(){return o.get(t)})}),[2,i]}})})},t.prototype.registerConfgureDepds=function(r,i){return d.__awaiter(this,void 0,void 0,function(){var e,n=this;return d.__generator(this,function(t){switch(t.label){case 0:return f.isArray(i.imports)&&i.imports.length?[4,r.get(f.ContainerBuilderToken).loader.loadTypes(i.imports,function(t){return n.isIocExt(t)||n.isDIModule(t)})]:[3,3];case 1:return e=t.sent(),[4,Promise.all(e.map(function(t){return n.importModule(t,r)}))];case 2:t.sent(),t.label=3;case 3:return f.isArray(i.providers)&&i.providers.length&&(i[a]=this.bindProvider(r,i.providers)),[2,i]}})})},t.prototype.getMetaConfig=function(t){var e=this.getDecorator();if(this.isDIModule(t)){var n=f.getTypeMetadata(e,t);if(n&&n.length){var r=n[0];return f.lang.omit(r,"builder")}}return null},t.prototype.isIocExt=function(t){return f.hasOwnClassMetadata(f.IocExt,t)},t.prototype.isDIModule=function(t){return!!f.isClass(t)&&(!!f.hasOwnClassMetadata(this.getDecorator(),t)||f.hasOwnClassMetadata(i.DIModule,t))},t.prototype.registerExts=function(e,t){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(t){return e.hasRegister(h.AnnotationBuilder)||e.register(h.AnnotationBuilder),[2,e]})})},t.prototype.bindProvider=function(i,t){var o=[];return t.forEach(function(n,t){if(!f.isUndefined(n)&&!f.isNull(n))if(f.isProviderMap(n))n.forEach(function(t,e){o.push(t),i.bindProvider(t,e)});else if(n instanceof f.Provider)o.push(n.type),i.bindProvider(n.type,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.resolve.apply(n,[i].concat(t))});else if(f.isClass(n))i.has(n)||(o.push(n),i.register(n));else if(f.isBaseObject(n)){var e=n,r=!1;f.isToken(e.provide)?(f.isArray(e.deps)&&e.deps.length&&e.deps.forEach(function(t){f.isClass(t)&&!i.has(t)&&i.register(t)}),f.isUndefined(e.useValue)?f.isClass(e.useClass)?(i.has(e.useClass)||i.register(e.useClass),o.push(e.provide),i.bindProvider(e.provide,e.useClass)):f.isFunction(e.useFactory)?(o.push(e.provide),i.bindProvider(e.provide,function(){var t=[];return f.isArray(e.deps)&&e.deps.length&&(t=e.deps.map(function(t){return f.isClass(t)?i.get(t):t})),e.useFactory.apply(e,t)})):f.isToken(e.useExisting)?i.has(e.useExisting)?(o.push(e.provide),i.bindProvider(e.provide,e.useExisting)):console.log("has not register:",e.useExisting):r=!0:(o.push(e.provide),i.bindProvider(e.provide,function(){return e.useValue}))):r=!0,r&&f.lang.forIn(n,function(t,e){f.isUndefined(t)||(f.isClass(t)?i.bindProvider(e,t):f.isFunction(t)||f.isString(t)?i.bindProvider(e,function(){return t}):i.bindProvider(e,t),o.push(e))})}else f.isFunction(n)&&(o.push(name),i.bindProvider(name,function(){return n}))}),o},t.classAnnations={name:"ModuleBuilder",params:{constructor:[],getPools:[],setPools:["pools"],regDefaultContainer:[],getContainer:["token","defaultContainer","parent"],setParent:["container","parent"],createContainer:[],getContainerBuilder:[],createContainerBuilder:[],load:["token","defaultContainer","parent"],build:["token","defaults","data"],bootstrap:["token","defaults","data"],loadByDefaults:["token","defaults"],getBuilder:["container","cfg"],getTypeBuilder:["container","typeBuilder"],getDefaultTypeBuilder:["container"],importModule:["token","container"],getDecorator:[],getConfigure:["token","container"],registerDepdences:["container","config"],getBootstrapToken:["cfg"],importConfigExports:["container","providerContainer","cfg"],registerConfgureDepds:["container","config"],getMetaConfig:["bootModule"],isIocExt:["token"],isDIModule:["token"],registerExts:["container","config"],bindProvider:["container","providers"]}},d.__decorate([f.Inject(f.ContainerBuilderToken),d.__metadata("design:type",Object)],t.prototype,"containerBuilder",void 0),t=r=d.__decorate([f.Singleton(s.ModuleBuilderToken),d.__metadata("design:paramtypes",[])],t)}();e.ModuleBuilder=n});t(c),c.InjectModuleLoadToken,c.ModuleBuilder;var y=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(o){function e(t){var e=o.call(this)||this;return e.baseURL=t,e.globalModules=[],e.customRegs=[],e.pools=new v.ContainerPool,e}return d.__extends(e,o),e.create=function(t){return new e(t)},e.prototype.useConfiguration=function(t,e){var r;if(this.globalConfig||(this.globalConfig=Promise.resolve(this.getDefaultConfig())),f.isString(t)){if(e){var n=e.resolve(f.ContainerBuilderToken);r=n.loader.load([t]).then(function(t){return t.length?t[0]:null})}}else t&&(r=Promise.resolve(t));return r&&(this.globalConfig=this.globalConfig.then(function(n){return r.then(function(t){var e=t.default?t.default:t;return n=f.lang.assign(n||{},e||{})})})),this},e.prototype.use=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this.globalModules=this.globalModules.concat(t),this},e.prototype.registerConfgureDepds=function(n,r){return d.__awaiter(this,void 0,void 0,function(){var e;return d.__generator(this,function(t){switch(t.label){case 0:return this.globalConfig||this.useConfiguration(),[4,this.globalConfig];case 1:return e=t.sent(),r=this.mergeGlobalConfig(e,r),this.bindAppConfig(r),[4,o.prototype.registerConfgureDepds.call(this,n,r)];case 2:return r=t.sent(),n.bindProvider(a.AppConfigureToken,r),[2,r]}})})},e.prototype.mergeGlobalConfig=function(t,e){return f.lang.assign({},t,e)},e.prototype.regDefaultContainer=function(){var t=this,e=o.prototype.regDefaultContainer.call(this);return e.bindProvider(v.ContainerPoolToken,function(){return t.getPools()}),e.resolve(s.ModuleBuilderToken).setPools(this.getPools()),e},e.prototype.registerExts=function(r,i){return d.__awaiter(this,void 0,void 0,function(){var e,n=this;return d.__generator(this,function(t){switch(t.label){case 0:return[4,o.prototype.registerExts.call(this,r,i)];case 1:return t.sent(),this.globalModules.length?(e=this.globalModules,[4,r.loadModule.apply(r,e)]):[3,3];case 2:t.sent(),t.label=3;case 3:return this.customRegs.length?[4,Promise.all(this.customRegs.map(function(e){return d.__awaiter(n,void 0,void 0,function(){return d.__generator(this,function(t){switch(t.label){case 0:return[4,e(r,i,this)];case 1:return[2,t.sent()]}})})}))]:[3,5];case 4:t.sent(),t.label=5;case 5:return[2,r]}})})},e.prototype.bindAppConfig=function(t){return this.baseURL&&(t.baseURL=this.baseURL),t},e.prototype.getDefaultConfig=function(){return{debug:!1}},e.classAnnations={name:"DefaultApplicationBuilder",params:{constructor:["baseURL"],create:["baseURL"],useConfiguration:["config","container"],use:["modules"],registerConfgureDepds:["container","config"],mergeGlobalConfig:["globalCfg","moduleCfg"],regDefaultContainer:[],registerExts:["container","config"],bindAppConfig:["config"],getDefaultConfig:[]}},e}(c.ModuleBuilder);e.DefaultApplicationBuilder=n});t(y),y.DefaultApplicationBuilder;var _=e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ApplicationBuilderToken=new f.InjectToken("DI_AppBuilder")});return t(_),_.ApplicationBuilderToken,t(e(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),d.__exportStar(i,e),d.__exportStar(a,e),d.__exportStar(y,e),d.__exportStar(_,e),d.__exportStar(s,e),d.__exportStar(c,e),d.__exportStar(v,e),d.__exportStar(u,e),d.__exportStar(p,e),d.__exportStar(h,e),d.__exportStar(l,e)}))}(c,l)});e(s);var u=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"ActivityBuilder",t)||this}return c.__extends(t,e),t.classAnnations={name:"InjectAcitityBuilderToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectAcitityBuilderToken=n,e.ActivityBuilderToken=new n("activity")});e(u);u.InjectAcitityBuilderToken,u.ActivityBuilderToken;var d=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n,r=function(e){function t(t){return e.call(this,"ActivityRunner",t)||this}return c.__extends(t,e),t.classAnnations={name:"InjectWorkflowToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectWorkflowToken=r,e.WorkflowToken=new r(""),(n=e.RunState||(e.RunState={}))[n.init=0]="init",n[n.running=1]="running",n[n.pause=2]="pause",n[n.stop=3]="stop",n[n.complete=4]="complete"});e(d);d.InjectWorkflowToken,d.WorkflowToken,d.RunState;var f=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"Activity",t)||this}return c.__extends(t,e),t.classAnnations={name:"InjectAcitityToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectAcitityToken=n,e.ActivityToken=new n("")});e(f);f.InjectAcitityToken,f.ActivityToken;var p=n(function(t,e){function n(e,n,r,i,o){return l.createClassDecorator("Task",function(t){i&&i(t),t.next({match:function(t){return t&&(l.isString(t)||l.isObject(t)&&t instanceof l.Registration)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.provide=e}}),t.next({match:function(t){return l.isString(t)||l.isToken(t)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.annotationBuilder=e}}),t.next({match:function(t){return l.isString(t)},setMetadata:function(t,e){t.name=e}})},function(t){return o&&(t=o(t)),!t.name&&l.isClass(t.type)&&(/^[a-z]$/.test(t.type.name)&&t.type.classAnnations?t.name=t.type.classAnnations.name:t.name=t.type.name),t.provide=t.provide||r,t.alias=t.alias||t.name,t.decorType=e,n&&!t.annotationBuilder&&(t.annotationBuilder=n),t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createTaskDecorator=n,e.Task=n("Task",u.ActivityBuilderToken,f.ActivityToken)});e(p);p.createTaskDecorator,p.Task;var h=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"Workflow",t)||this}return c.__extends(t,e),t.classAnnations={name:"InjectWorkflowBuilder",params:{constructor:["desc"]}},t}(l.Registration);e.InjectWorkflowBuilder=n,e.WorkflowBuilderToken=new n(""),e.DefaultWorkflowBuilderToken=new n("default")});e(h);h.InjectWorkflowBuilder,h.WorkflowBuilderToken,h.DefaultWorkflowBuilderToken;var v=n(function(t,e){function n(t,e,n,r,i){return s.createDIModuleDecorator(t,e,n,function(t){r&&r(t),t.next({match:function(t){return t&&(l.isString(t)||l.isObject(t)&&t instanceof l.Registration)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.provide=e}}),t.next({match:function(t){return l.isString(t)||l.isToken(t)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.annotationBuilder=e}}),t.next({match:function(t){return l.isString(t)},setMetadata:function(t,e){t.name=e}})},i)}Object.defineProperty(e,"__esModule",{value:!0}),e.createWorkflowDecorator=n,e.Workflow=n("Workflow",h.DefaultWorkflowBuilderToken,u.ActivityBuilderToken)});e(v);v.createWorkflowDecorator,v.Workflow;var y=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(p,e),c.__exportStar(v,e)});e(y);var _=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.UUIDToken=new l.InjectToken("uuid_factory");var n=function(){function t(){}return t.prototype.generate=function(){return this.randomS4()+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+this.randomS4()+this.randomS4()},t.prototype.randomS4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},t.classAnnations={name:"RandomUUIDFactory",params:{constructor:[],generate:[],randomS4:[]}},c.__decorate([l.Singleton(e.UUIDToken),c.__metadata("design:paramtypes",[])],t)}();e.RandomUUIDFactory=n});e(_);_.UUIDToken,_.RandomUUIDFactory;var g=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n,r){this.activities=t,this.uuid=e,this.instance=n,this.activityBuilder=r,this._result=new i.BehaviorSubject(null),this.stateChanged=new i.BehaviorSubject(d.RunState.init)}return Object.defineProperty(t.prototype,"activity",{get:function(){return this.activities},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"activityInstance",{get:function(){return this.instance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"result",{get:function(){return this._result.filter(function(t){return!t})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resultValue",{get:function(){return this._resultValue},enumerable:!0,configurable:!0}),t.prototype.onInit=function(){this.container.bindProvider(this.getUUID(),this)},t.prototype.getUUID=function(){return this.uuid||(this.instance&&this.instance.id?this.uuid=this.instance.id:l.isToken(this.activity)&&(this.uuid=this.createUUID()),this.uuid=this.uuid||this.createUUID()),this.uuid},t.prototype.getBuilder=function(){return this.activityBuilder||(this.activityBuilder=this.container.resolve(u.ActivityBuilderToken)),this.activityBuilder},t.prototype.getInstance=function(){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return this.instance?[3,2]:[4,(e=this).getBuilder().buildByConfig(this.activity,this.getUUID())];case 1:e.instance=t.sent(),t.label=2;case 2:return[2,this.instance]}})})},t.prototype.getBaseURL=function(){return this.instance?this.instance.config.baseURL:"."},t.prototype.start=function(n){return c.__awaiter(this,void 0,void 0,function(){var e=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.getInstance()];case 1:return[2,t.sent().run(n).then(function(t){return e.state=d.RunState.complete,e.stateChanged.next(e.state),e._resultValue=t,e._result.next(t),t})]}})})},t.prototype.saveState=function(t){this._currState=t},t.prototype.stop=function(){this.state=d.RunState.stop,this.stateChanged.next(this.state)},t.prototype.pause=function(){this.state=d.RunState.pause,this.stateChanged.next(this.state)},t.prototype.createUUID=function(){return this.container.has(_.UUIDToken)||this.container.register(_.RandomUUIDFactory),this.container.get(_.UUIDToken).generate()},t.classAnnations={name:"DefaultWorkflow",params:{constructor:["activities","uuid","instance","activityBuilder"],onInit:[],getUUID:[],getBuilder:[],getInstance:[],getBaseURL:[],start:["data"],saveState:["state"],stop:[],pause:[],createUUID:[]}},c.__decorate([l.Inject(l.ContainerToken),c.__metadata("design:type",Object)],t.prototype,"container",void 0),c.__decorate([y.Workflow(d.WorkflowToken),c.__metadata("design:paramtypes",[Object,String,Object,Object])],t)}();e.DefaultWorkflow=n});e(g);g.DefaultWorkflow;var b=n(function(t,e){function n(t){return t instanceof g.DefaultWorkflow}Object.defineProperty(e,"__esModule",{value:!0}),e.isActivityRunner=n,e.isActivityType=function(t,e){return void 0===e&&(e=!0),!(!t||n(t)||l.isString(t)||!l.isToken(t)&&(!l.isMetadataObject(t)||e&&!(t.activity||t.task||t.bootstrap)))}});e(b);b.isActivityRunner,b.isActivityType;var A=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"ActivityContext",t)||this}return c.__extends(t,e),t.classAnnations={name:"InjectContextToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectContextToken=n,e.ContextToken=new n("")});e(A);A.InjectContextToken,A.ContextToken;var k=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.onActivityInit=function(t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2]})})},t.prototype.run=function(t,e){return Promise.resolve(t)},t.prototype.toExpression=function(t,e){return this.context.builder.toExpression(t,e||this)},t.prototype.toActivity=function(t,e,n,r,i){return this.context.builder.toActivity(t,i||this,e,n,r)},t.prototype.buildActivity=function(t){return this.context.builder.buildByConfig(t,this.id)},t.classAnnations={name:"Activity",params:{constructor:[],onActivityInit:["config"],run:["data","execute"],toExpression:["exptype","target"],toActivity:["exptype","isRightActivity","toConfig","valify","target"],buildActivity:["config"]}},c.__decorate([l.Inject(A.ContextToken),c.__metadata("design:type",Object)],t.prototype,"context",void 0),c.__decorate([y.Task,c.__metadata("design:paramtypes",[])],t)}();e.Activity=n});e(k);k.Activity;var m=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(a){function t(){return null!==a&&a.apply(this,arguments)||this}return c.__extends(t,a),t.prototype.build=function(t,e,n){return a.prototype.build.call(this,t,e,n)},t.prototype.buildByConfig=function(t,e){return a.prototype.buildByConfig.call(this,t,e)},t.prototype.createInstance=function(r,i,o){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return l.isString(r)&&(r=this.traslateStrToken(r)),[4,a.prototype.createInstance.call(this,r,i,o)];case 1:return(e=t.sent())&&e instanceof k.Activity?[3,3]:(n=this.getDefaultAcitvity(),console.log("try load default activity:",l.getClassName(n)),[4,this.build(n,i,o)]);case 2:e=t.sent(),t.label=3;case 3:return l.isString(o)&&(e.id=o),l.isFunction(e.onActivityInit)?[4,Promise.resolve(e.onActivityInit(i))]:[3,5];case 4:t.sent(),t.label=5;case 5:return[2,e]}})})},t.prototype.buildStrategy=function(e,n,t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return n.name&&(e.name=n.name),e.config=n,[2,e]})})},t.prototype.getDefaultAcitvity=function(){return k.Activity},t.prototype.getBootstrapToken=function(t){var e=t.activity||t.task||t.bootstrap;return l.isString(e)&&(e=this.traslateStrToken(e)),e},t.prototype.getDecorator=function(){return y.Task.toString()},t.prototype.resolveToken=function(t,e){var n=this.container.resolve(t);return n.id=e,n},t.prototype.traslateStrToken=function(t){var e=new l.Registration(f.ActivityToken,t);return this.container.has(e)?e:t},t.prototype.toExpression=function(e,n){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return b.isActivityType(e)?[4,this.buildByConfig(e,n.id)]:[3,2];case 1:return[2,t.sent()];case 2:return[2,e]}})})},t.prototype.toActivity=function(i,o,a,s,u){return c.__awaiter(this,void 0,void 0,function(){var e,n,r;return c.__generator(this,function(t){switch(t.label){case 0:return b.isActivityType(i,!u)?u?[4,this.buildByConfig(l.isToken(i)?i:u(i),o.id)]:[3,2]:[3,5];case 1:return e=t.sent(),[3,4];case 2:return[4,this.buildByConfig(i,o.id)];case 3:e=t.sent(),t.label=4;case 4:return[3,6];case 5:e=i,t.label=6;case 6:return a(e)?[2,e]:l.isString(e)?(n=e,[3,9]):[3,7];case 7:return[4,o.context.exec(o,e)];case 8:n=t.sent(),t.label=9;case 9:return r=s(n),u&&(r=u(r)),r?[4,this.buildByConfig(r,o.id)]:[3,11];case 10:return e=t.sent(),[3,12];case 11:e=null,t.label=12;case 12:return[2,e]}})})},t.classAnnations={name:"ActivityBuilder",params:{build:["token","config","data"],buildByConfig:["activity","data"],createInstance:["token","config","uuid"],buildStrategy:["activity","config","container"],getDefaultAcitvity:[],getBootstrapToken:["config"],getDecorator:[],resolveToken:["token","uuid"],traslateStrToken:["token"],toExpression:["exptype","target"],toActivity:["exptype","target","isRightActivity","toConfig","valify"]}},c.__decorate([l.Singleton(u.ActivityBuilderToken)],t)}(s.AnnotationBuilder);e.ActivityBuilder=n});e(m);m.ActivityBuilder;var T=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return c.__extends(e,t),e.classAnnations={name:"ExpressionActivity",params:{}},c.__decorate([y.Task],e)}(k.Activity);e.ExpressionActivity=n;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return c.__extends(e,t),e.classAnnations={name:"AssignActivity",params:{}},c.__decorate([y.Task],e)}(k.Activity);e.AssignActivity=r});e(T);T.ExpressionActivity,T.AssignActivity;var w=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.getContainer=function(){return this.container},t.prototype.getRootPath=function(){return(this.getContainer().get(s.AppConfigureToken)||{}).baseURL||"."},t.prototype.createRunner=function(t,e,n,r){var i;return l.isToken(n)?i=this.container.resolve(n):n instanceof m.ActivityBuilder&&(i=n),this.container.resolve(d.WorkflowToken,{activity:t,uuid:e,instance:r,activityBuilder:i})},t.prototype.getEnvArgs=function(){return{}},t.prototype.to=function(t,e){return l.isFunction(t)?l.isClass(t)?t:t(this,e):t},t.prototype.exec=function(t,e,n){return l.isFunction(e)?e(t,n):l.isPromise(e)?e:e instanceof k.Activity?e.run(n,t):e instanceof g.DefaultWorkflow?e.start(n):Promise.resolve(e)},t.prototype.isTask=function(t){return l.hasOwnClassMetadata(y.Task,t)},t.classAnnations={name:"Context",params:{constructor:[],getContainer:[],getRootPath:[],createRunner:["task","uuid","builder","instance"],getEnvArgs:[],to:["target","config"],exec:["target","expression","data"],isTask:["task"]}},c.__decorate([l.Inject(l.ContainerToken),c.__metadata("design:type",Object)],t.prototype,"container",void 0),c.__decorate([l.Inject(u.ActivityBuilderToken),c.__metadata("design:type",m.ActivityBuilder)],t.prototype,"builder",void 0),c.__decorate([l.Singleton(A.ContextToken),c.__metadata("design:paramtypes",[])],t)}();e.Context=n});e(w);w.Context;var C=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(u,e),c.__exportStar(m,e),c.__exportStar(f,e),c.__exportStar(k,e),c.__exportStar(T,e),c.__exportStar(b,e),c.__exportStar(_,e),c.__exportStar(y,e),c.__exportStar(A,e),c.__exportStar(w,e),c.__exportStar(d,e),c.__exportStar(g,e)});e(C);var x=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DelayActivityToken=new C.InjectAcitityToken("delay");var n=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return c.__extends(t,r),t.prototype.onActivityInit=function(n){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,r.prototype.onActivityInit.call(this,n)];case 1:return t.sent(),[4,(e=this).toExpression(n.delay,this)];case 2:return e.delay=t.sent(),[2]}})})},t.prototype.run=function(i){return c.__awaiter(this,void 0,void 0,function(){var e,n,r;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.delay,i)];case 1:return e=t.sent(),n=new l.Defer,r=setTimeout(function(){n.resolve(i),clearTimeout(r)},e),[4,n.promise];case 2:return[2,t.sent()]}})})},t.classAnnations={name:"DelayActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.DelayActivityToken)],t)}(C.Activity);e.DelayActivity=n});e(x);x.DelayActivityToken,x.DelayActivity;var B=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.IntervalActivityToken=new C.InjectAcitityToken("interval");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return c.__extends(t,i),t.prototype.onActivityInit=function(r){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).toExpression(r.interval)];case 2:return e.interval=t.sent(),[4,(n=this).buildActivity(r.body)];case 3:return n.body=t.sent(),[2]}})})},t.prototype.run=function(i){return c.__awaiter(this,void 0,void 0,function(){var e,n,r=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.interval,i)];case 1:return e=t.sent(),n=i,setInterval(function(){r.body.run(n)},e),[2,i]}})})},t.classAnnations={name:"IntervalActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.IntervalActivityToken)],t)}(C.Activity);e.IntervalActivity=n});e(B);B.IntervalActivityToken,B.IntervalActivity;var I=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DoWhileActivityToken=new C.InjectAcitityToken("dowhile");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return c.__extends(t,i),t.prototype.onActivityInit=function(r){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).buildActivity(r.do)];case 2:return e.body=t.sent(),[4,(n=this).toExpression(r.while)];case 3:return n.condition=t.sent(),[2]}})})},t.prototype.run=function(r){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.body.run(r)];case 1:return e=t.sent(),[4,this.context.exec(this,this.condition,e)];case 2:n=t.sent(),t.label=3;case 3:return n?[4,this.body.run(e||r)]:[3,6];case 4:return e=t.sent(),[4,this.context.exec(this,this.condition,e)];case 5:return n=t.sent(),[3,3];case 6:return[2,e]}})})},t.classAnnations={name:"DoWhileActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.DoWhileActivityToken)],t)}(C.Activity);e.DoWhileActivity=n});e(I);I.DoWhileActivityToken,I.DoWhileActivity;var D=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.IfActivityToken=new C.InjectAcitityToken("if");var n=function(o){function t(){return null!==o&&o.apply(this,arguments)||this}return c.__extends(t,o),t.prototype.onActivityInit=function(i){return c.__awaiter(this,void 0,void 0,function(){var e,n,r;return c.__generator(this,function(t){switch(t.label){case 0:return[4,o.prototype.onActivityInit.call(this,i)];case 1:return t.sent(),[4,(e=this).buildActivity(i.ifBody)];case 2:return e.ifBody=t.sent(),[4,(n=this).toExpression(i.if)];case 3:return n.condition=t.sent(),i.elseBody?[4,(r=this).buildActivity(i.elseBody)]:[3,5];case 4:r.elseBody=t.sent(),t.label=5;case 5:return[2]}})})},t.prototype.run=function(e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.condition,e)];case 1:return t.sent()?[2,this.execIf(e)]:this.elseBody?[2,this.execElse(e)]:[2,Promise.resolve(e)]}})})},t.prototype.execIf=function(t){return this.ifBody.run(t)},t.prototype.execElse=function(t){return this.elseBody.run(t)},t.classAnnations={name:"IfActivity",params:{onActivityInit:["config"],run:["data"],execIf:["data"],execElse:["data"]}},c.__decorate([C.Task(e.IfActivityToken)],t)}(C.Activity);e.IfActivity=n});e(D);D.IfActivityToken,D.IfActivity;var P=n(function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.InvokeActivityToken=new C.InjectAcitityToken("invoke");var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return c.__extends(e,t),e.prototype.run=function(e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2,this.context.getContainer().invoke(this.targetType,this.target,this.args,{data:e})]})})},e.classAnnations={name:"InvokeActivity",params:{run:["data"]}},c.__decorate([C.Task(n.InvokeActivityToken)],e)}(C.Activity);n.InvokeActivity=e});e(P);P.InvokeActivityToken,P.InvokeActivity;var M=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ParallelActivityToken=new C.InjectAcitityToken("parallel");var n=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.activites=[],t}var o;return c.__extends(t,n),(o=t).prototype.onActivityInit=function(e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return[4,n.prototype.onActivityInit.call(this,e)];case 1:return t.sent(),e.parallel&&e.parallel.length?[4,this.buildChildren(this,e.parallel)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.buildChildren=function(n,i){return c.__awaiter(this,void 0,void 0,function(){var e,r=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,Promise.all(i.map(function(n){return c.__awaiter(r,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n)];case 1:return(e=t.sent())?e instanceof o&&!l.isToken(n)&&n.parallel&&n.parallel.length?[4,e.buildChildren(e,n.parallel)]:[3,3]:[2,null];case 2:t.sent(),t.label=3;case 3:return[2,e]}})})}))];case 1:return e=t.sent(),n.activites=e,[2,n]}})})},t.prototype.run=function(n,r){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.before(n,r)];case 1:return e=t.sent(),[4,this.execute(e,r)];case 2:return e=t.sent(),[4,this.after(e,r)];case 3:return[2,e=t.sent()]}})})},t.prototype.before=function(e,t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2,e]})})},t.prototype.execute=function(e,t){return Promise.all(this.activites.map(function(t){return t.run(e)}))},t.prototype.after=function(e,t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2,e]})})},t.classAnnations={name:"ParallelActivity",params:{onActivityInit:["config"],buildChildren:["activity","configs"],run:["data","execute"],before:["data","execute"],execute:["data","execute"],after:["data","execute"]}},o=c.__decorate([C.Task(e.ParallelActivityToken)],t)}(C.Activity);e.ParallelActivity=n});e(M);M.ParallelActivityToken,M.ParallelActivity;var S=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SequenceActivityToken=new C.InjectAcitityToken("sequence");var n=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.activites=[],t}var o;return c.__extends(t,n),(o=t).prototype.onActivityInit=function(e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return[4,n.prototype.onActivityInit.call(this,e)];case 1:return t.sent(),e.sequence&&e.sequence.length?[4,this.buildChildren(this,e.sequence)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.buildChildren=function(n,i){return c.__awaiter(this,void 0,void 0,function(){var e,r=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,Promise.all(i.map(function(n){return c.__awaiter(r,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n)];case 1:return(e=t.sent())?e instanceof o&&!l.isToken(n)&&n.sequence&&n.sequence.length?[4,e.buildChildren(e,n.sequence)]:[3,3]:[2,null];case 2:t.sent(),t.label=3;case 3:return[2,e]}})})}))];case 1:return e=t.sent(),n.activites=e,[2,n]}})})},t.prototype.run=function(n,r){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.before(n,r)];case 1:return e=t.sent(),[4,this.execute(e,r)];case 2:return e=t.sent(),[4,this.after(e,r)];case 3:return[2,e=t.sent()]}})})},t.prototype.before=function(e,t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2,e]})})},t.prototype.execute=function(t,e){var n=Promise.resolve(t);return this.activites.forEach(function(e){n=n.then(function(t){return e.run(t)})}),n},t.prototype.after=function(e,t){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){return[2,e]})})},t.classAnnations={name:"SequenceActivity",params:{onActivityInit:["config"],buildChildren:["activity","configs"],run:["data","execute"],before:["data","execute"],execute:["data","execute"],after:["data","execute"]}},o=c.__decorate([C.Task(e.SequenceActivityToken)],t)}(C.Activity);e.SequenceActivity=n});e(S);S.SequenceActivityToken,S.SequenceActivity;var j=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SwitchActivityToken=new C.InjectAcitityToken("switch");var n=function(o){function t(){var t=null!==o&&o.apply(this,arguments)||this;return t.cases=new l.MapSet,t}return c.__extends(t,o),t.prototype.onActivityInit=function(i){return c.__awaiter(this,void 0,void 0,function(){var e,n,r=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,o.prototype.onActivityInit.call(this,i)];case 1:return t.sent(),[4,(e=this).toExpression(i.expression)];case 2:return e.expression=t.sent(),i.cases&&i.cases.length?[4,Promise.all(i.cases.map(function(n){return c.__awaiter(r,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n.value)];case 1:return e=t.sent(),this.cases.set(n.key,e),[2,e]}})})}))]:[3,4];case 3:t.sent(),t.label=4;case 4:return i.defaultBody?[4,(n=this).buildActivity(i.defaultBody)]:[3,6];case 5:n.defaultBody=t.sent(),t.label=6;case 6:return[2]}})})},t.prototype.run=function(n){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.expression,n)];case 1:return e=t.sent(),!l.isUndefined(e)&&this.cases.has(e)?[2,this.cases.get(e).run(n)]:this.defaultBody?[2,this.defaultBody.run(n)]:[2,Promise.resolve(n)]}})})},t.classAnnations={name:"SwitchActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.SwitchActivityToken)],t)}(C.Activity);e.SwitchActivity=n});e(j);j.SwitchActivityToken,j.SwitchActivity;var O=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ThrowActivityToken=new C.InjectAcitityToken("throw");var n=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return c.__extends(t,r),t.prototype.onActivityInit=function(n){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,r.prototype.onActivityInit.call(this,n)];case 1:return t.sent(),[4,(e=this).toExpression(n.exception)];case 2:return e.exception=t.sent(),[2]}})})},t.prototype.run=function(e){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.exception,e)];case 1:throw t.sent()}})})},t.classAnnations={name:"ThrowActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.ThrowActivityToken)],t)}(C.Activity);e.ThrowActivity=n});e(O);O.ThrowActivityToken,O.ThrowActivity;var R=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TryCatchActivityToken=new C.InjectAcitityToken("trycatch");var n=function(a){function t(){var t=null!==a&&a.apply(this,arguments)||this;return t.catchs=[],t}return c.__extends(t,a),t.prototype.onActivityInit=function(o){return c.__awaiter(this,void 0,void 0,function(){var e,n,r,i=this;return c.__generator(this,function(t){switch(t.label){case 0:return[4,a.prototype.onActivityInit.call(this,o)];case 1:return t.sent(),[4,(e=this).buildActivity(o.try)];case 2:return e.try=t.sent(),o.catchs&&o.catchs.length?[4,Promise.all(o.catchs.map(function(t){return i.buildActivity(t)}))]:[3,4];case 3:n=t.sent(),this.catchs=n,t.label=4;case 4:return o.finally?[4,(r=this).buildActivity(o.finally)]:[3,6];case 5:r.finally=t.sent(),t.label=6;case 6:return[2]}})})},t.prototype.run=function(r){return c.__awaiter(this,void 0,void 0,function(){var n,e=this;return c.__generator(this,function(t){try{n=this.try.run(r),this.catchs.forEach(function(e){n=n.catch(function(t){return e.run(t)})}),this.finally&&n.then(function(t){return e.finally.run(t)})}catch(t){n=Promise.resolve(r),this.finally&&n.then(function(t){return e.finally.run(t)})}return[2,n]})})},t.classAnnations={name:"TryCatchActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.TryCatchActivityToken)],t)}(k.Activity);e.TryCatchActivity=n});e(R);R.TryCatchActivityToken,R.TryCatchActivity;var U=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WhileActivityToken=new C.InjectAcitityToken("while");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return c.__extends(t,i),t.prototype.onActivityInit=function(r){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).buildActivity(r.body)];case 2:return e.body=t.sent(),[4,(n=this).toExpression(r.while)];case 3:return n.condition=t.sent(),[2]}})})},t.prototype.run=function(r){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.condition,r)];case 1:e=t.sent(),t.label=2;case 2:return e?[4,this.body.run(n||r)]:[3,5];case 3:return n=t.sent(),[4,this.context.exec(this,this.condition,n)];case 4:return e=t.sent(),[3,2];case 5:return[2,n]}})})},t.classAnnations={name:"WhileActivity",params:{onActivityInit:["config"],run:["data"]}},c.__decorate([C.Task(e.WhileActivityToken)],t)}(C.Activity);e.WhileActivity=n});e(U);U.WhileActivityToken,U.WhileActivity;var E=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(x,e),c.__exportStar(B,e),c.__exportStar(I,e),c.__exportStar(D,e),c.__exportStar(P,e),c.__exportStar(M,e),c.__exportStar(S,e),c.__exportStar(j,e),c.__exportStar(O,e),c.__exportStar(R,e),c.__exportStar(U,e)});e(E);var W=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.beforeRun=function(t){var e=this.getRunner(t.target);if(e)switch(e.saveState(t),e.state){case C.RunState.pause:throw new Error("workflow paused!");case C.RunState.stop:throw new Error("workflow stop!")}},t.prototype.afterRun=function(t){var e=this.getRunner(t.target);if(e)switch(e.saveState(t),e.state){case C.RunState.pause:throw new Error("workflow paused!");case C.RunState.stop:throw new Error("workflow stop!")}},t.prototype.getRunner=function(t){return t instanceof C.Activity&&t.id&&this.container.has(t.id)?this.container.resolve(t.id):null},t.classAnnations={name:"RunAspect",params:{constructor:[],beforeRun:["joinPoint"],afterRun:["joinPoint"],getRunner:["task"]}},c.__decorate([l.Inject(l.ContainerToken),c.__metadata("design:type",Object)],t.prototype,"container",void 0),c.__decorate([r.Before("execution(*.run)"),c.__metadata("design:type",Function),c.__metadata("design:paramtypes",[r.Joinpoint]),c.__metadata("design:returntype",void 0)],t.prototype,"beforeRun",null),c.__decorate([r.AfterReturning("execution(*.run)"),c.__metadata("design:type",Function),c.__metadata("design:paramtypes",[r.Joinpoint]),c.__metadata("design:returntype",void 0)],t.prototype,"afterRun",null),c.__decorate([r.Aspect({annotation:C.Task,singleton:!0}),c.__metadata("design:paramtypes",[])],t)}();e.RunAspect=n});e(W);W.RunAspect;var L=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(W,e)});e(L);var q=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(s){function t(){return null!==s&&s.apply(this,arguments)||this}return c.__extends(t,s),t.prototype.bootstrap=function(i,o,a){return c.__awaiter(this,void 0,void 0,function(){var e,n,r;return c.__generator(this,function(t){switch(t.label){case 0:return e=this.getContainer(i,o),a=a||this.createUUID(e),[4,s.prototype.bootstrap.call(this,i,o,a)];case 1:return n=t.sent(),[4,(r=e.resolve(C.WorkflowToken,{activities:i,instance:n,uuid:a})).start()];case 2:return t.sent(),[2,r]}})})},t.prototype.createUUID=function(t){return t.has(C.UUIDToken)||t.register(C.RandomUUIDFactory),t.get(C.UUIDToken).generate()},t.prototype.registerExts=function(e,n){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(t){switch(t.label){case 0:return[4,s.prototype.registerExts.call(this,e,n)];case 1:return t.sent(),e.has(r.AopModule)||e.register(r.AopModule),e.has(o.LogModule)||e.register(o.LogModule),e.has(F.CoreModule)||e.register(F.CoreModule),[2,e]}})})},t.prototype.getDefaultTypeBuilder=function(t){return t.resolve(C.ActivityBuilderToken)},t.prototype.getDecorator=function(){return C.Task.toString()},t.prototype.getBootstrapToken=function(t){return t.activity||t.task||t.bootstrap},t.classAnnations={name:"DefaultWorkflowBuilder",params:{bootstrap:["activity","defaultContainer","workflowId"],createUUID:["container"],registerExts:["container","config"],getDefaultTypeBuilder:["container"],getDecorator:[],getBootstrapToken:["config"]}},c.__decorate([l.Singleton(h.DefaultWorkflowBuilderToken)],t)}(s.ModuleBuilder);e.DefaultWorkflowBuilder=n});e(q);q.DefaultWorkflowBuilder;var F=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container,e=t.getLifeScope();e.registerDecorator(C.Workflow,l.CoreActions.bindProvider,l.CoreActions.cache,l.CoreActions.componentBeforeInit,l.CoreActions.componentInit,l.CoreActions.componentAfterInit),e.registerDecorator(C.Task,l.CoreActions.bindProvider,l.CoreActions.cache,l.CoreActions.componentBeforeInit,l.CoreActions.componentInit,l.CoreActions.componentAfterInit),t.register(C.ActivityBuilder),t.register(C.DefaultWorkflow),t.register(C.Context),t.register(L.RunAspect),t.register(C.Activity),t.register(q.DefaultWorkflowBuilder),t.use(E)},t.classAnnations={name:"CoreModule",params:{constructor:["container"],setup:[]}},c.__decorate([l.IocExt("setup"),c.__param(0,l.Inject(l.ContainerToken)),c.__metadata("design:paramtypes",[Object])],t)}();e.CoreModule=n});e(F);F.CoreModule;var K=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.baseURL=t}return t.prototype.getContainer=function(){return this.container||(this.container=this.getBuilder().getPools().getDefault()),this.container},t.prototype.getBuilder=function(){return this.builder||(this.builder=this.createAppBuilder(),this.builder.use(r.AopModule).use(o.LogModule).use(F.CoreModule)),this.builder},t.prototype.createAppBuilder=function(){return new s.DefaultApplicationBuilder(this.baseURL)},t.prototype.useConfiguration=function(t,e){return this.getBuilder().useConfiguration(t,e),this},t.prototype.use=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.getBuilder()).use.apply(t,e),this},t.prototype.useLog=function(t){return l.hasClassMetadata(r.Aspect,t)?this.getBuilder().use(t):console.error("logAspect param is not right aspect"),this},t.prototype.getWorkflow=function(t){return this.getContainer().resolve(t)},t.prototype.createWorkflow=function(n,r){return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return[4,this.getBuilder().bootstrap(n,null,r)];case 1:return e=t.sent(),this.getContainer().bindProvider(e.getUUID(),e),[2,e]}})})},t.prototype.createActivity=function(r,i){return c.__awaiter(this,void 0,void 0,function(){var e,n;return c.__generator(this,function(t){switch(t.label){case 0:return l.isToken(r)?e={bootstrap:r,builder:h.DefaultWorkflowBuilderToken}:(e=r).builder=e.builder||h.DefaultWorkflowBuilderToken,[4,this.getBuilder().bootstrap(e,null,i)];case 1:return n=t.sent(),this.getContainer().bindProvider(n.getUUID(),n),[2,n]}})})},t.prototype.bootstrap=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return c.__awaiter(this,void 0,void 0,function(){var e;return c.__generator(this,function(t){switch(t.label){case 0:return e=1<n.length?{sequence:n,task:E.SequenceActivity}:l.lang.first(n),[4,this.createActivity(e)];case 1:return[2,t.sent()]}})})},t.classAnnations={name:"DefaultTaskContainer",params:{constructor:["baseURL"],getContainer:[],getBuilder:[],createAppBuilder:[],useConfiguration:["config","container"],use:["modules"],useLog:["logAspect"],getWorkflow:["workflowId"],createWorkflow:["workflow","workflowId"],createActivity:["activity","workflowId"],bootstrap:["activites"]}},t}();e.DefaultTaskContainer=n});e(K);K.DefaultTaskContainer;var V=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.pick=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r={};return t.forEach(function(t){r[t]=e[t]}),r}});e(V);V.pick;var G=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(V,e)});return e(G),e(n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),c.__exportStar(a,e),c.__exportStar(K,e),c.__exportStar(q,e),c.__exportStar(G,e),c.__exportStar(C,e),c.__exportStar(L,e),c.__exportStar(E,e),c.__exportStar(F,e)}))});