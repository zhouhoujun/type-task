!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("tslib"),require("@ts-ioc/core"),require("@ts-ioc/bootstrap"),require("rxjs/BehaviorSubject"),require("rxjs/add/operator/filter"),require("@ts-ioc/aop"),require("@ts-ioc/logs")):"function"==typeof define&&define.amd?define(["tslib","@ts-ioc/core","@ts-ioc/bootstrap","rxjs/BehaviorSubject","rxjs/add/operator/filter","@ts-ioc/aop","@ts-ioc/logs"],e):(t.core=t.core||{},t.core.umd=t.core.umd||{},t.core.umd.js=e(t.tslib_1,t.core_1,t.bootstrap_1,t.BehaviorSubject_1,t.filter,t.aop_1,t.logs))}(this,function(u,l,o,r,t,i,a){"use strict";function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function n(t,e){return t(e={exports:{}},e.exports),e.exports}u=u&&u.hasOwnProperty("default")?u.default:u,l=l&&l.hasOwnProperty("default")?l.default:l,o=o&&o.hasOwnProperty("default")?o.default:o,r=r&&r.hasOwnProperty("default")?r.default:r,t=t&&t.hasOwnProperty("default")?t.default:t,i=i&&i.hasOwnProperty("default")?i.default:i,a=a&&a.hasOwnProperty("default")?a.default:a;var c=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TaskContainerToken=new l.InjectToken("__TASK_TaskContainer")});e(c);c.TaskContainerToken;var s=n(function(t,e){function n(e,n,r,i,o){return l.createClassDecorator("Task",function(t){i&&i(t),t.next({match:function(t){return l.isString(t)||l.isObject(t)&&t instanceof l.Registration},setMetadata:function(t,e){l.isString(e)&&(t.name=e),t.provide=e}}),t.next({match:function(t){return l.isString(t)||l.isToken(t)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.annotationBuilder=e}}),t.next({match:function(t){return l.isString(t)},setMetadata:function(t,e){t.name=e}})},function(t){(o&&(t=o(t)),!t.name&&l.isClass(t.type))&&(/^[a-z]$/.test(t.type.name)&&t.type.classAnnations?t.name=t.type.classAnnations.name:t.name=t.type.name);return l.isUndefined(t.provide)&&(t.provide=t.name),r&&(l.isString(t.provide)&&(t.provide=new l.Registration(r,t.provide)),t.activity&&t.task||(t.activity=r)),t.decorType=e,n&&!t.annotationBuilder&&(t.annotationBuilder=n),t})}Object.defineProperty(e,"__esModule",{value:!0}),e.createTaskDecorator=n,e.Task=n("Task")});e(s);s.createTaskDecorator,s.Task;var d=n(function(t,e){function n(t,e,n,r,i){return o.createDIModuleDecorator(t,e,n,function(t){r&&r(t),t.next({match:function(t){return t&&(l.isString(t)||l.isObject(t)&&t instanceof l.Registration)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.provide=e}}),t.next({match:function(t){return l.isString(t)||l.isToken(t)},setMetadata:function(t,e){l.isString(e)?t.name=e:t.annotationBuilder=e}}),t.next({match:function(t){return l.isString(t)},setMetadata:function(t,e){t.name=e}})},i)}Object.defineProperty(e,"__esModule",{value:!0}),e.createWorkflowDecorator=n,e.Workflow=n("Workflow")});e(d);d.createWorkflowDecorator,d.Workflow;var f=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(s,e),u.__exportStar(d,e)});e(f);var p=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"Activity",t)||this}return u.__extends(t,e),t.classAnnations={name:"InjectAcitityToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectAcitityToken=n,e.ActivityToken=new n("")});e(p);p.InjectAcitityToken,p.ActivityToken;var v=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,"ActivityContext",t)||this}return u.__extends(t,e),t.classAnnations={name:"InjectContextToken",params:{constructor:["desc"]}},t}(l.Registration);e.InjectContextToken=n,e.ContextToken=new n("")});e(v);v.InjectContextToken,v.ContextToken;var y=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.onActivityInit=function(t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2]})})},t.prototype.run=function(t,e){return Promise.resolve(t)},t.prototype.toExpression=function(t,e){return this.context.builder.toExpression(t,e||this)},t.prototype.toActivity=function(t,e,n,r,i){return this.context.builder.toActivity(t,i||this,e,n,r)},t.prototype.buildActivity=function(t){return this.context.builder.buildByConfig(t,this.id)},t.classAnnations={name:"Activity",params:{constructor:[],onActivityInit:["config"],run:["data","execute"],toExpression:["exptype","target"],toActivity:["exptype","isRightActivity","toConfig","valify","target"],buildActivity:["config"]}},u.__decorate([l.Inject(v.ContextToken),u.__metadata("design:type",Object)],t.prototype,"context",void 0),t=u.__decorate([f.Task(p.ActivityToken),u.__metadata("design:paramtypes",[])],t)}();e.Activity=n});e(y);y.Activity;var _=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(e){function t(t){return e.call(this,t)||this}return u.__extends(t,e),t.classAnnations={name:"InjectAcitityBuilderToken",params:{constructor:["type"]}},t}(o.InjectAnnotationBuilder);e.InjectAcitityBuilderToken=n,e.ActivityBuilderToken=new n(y.Activity)});e(_);_.InjectAcitityBuilderToken,_.ActivityBuilderToken;var h=n(function(t,e){var n;Object.defineProperty(e,"__esModule",{value:!0}),e.ActivityRunnerToken=new o.InjectServiceToken(y.Activity),(n=e.RunState||(e.RunState={}))[n.init=0]="init",n[n.running=1]="running",n[n.pause=2]="pause",n[n.stop=3]="stop",n[n.complete=4]="complete"});e(h);h.ActivityRunnerToken,h.RunState;var A=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e,n){this.token=t,this.config=e,this.instance=n,this._result=new r.BehaviorSubject(null),this.stateChanged=new r.BehaviorSubject(h.RunState.init)}return Object.defineProperty(t.prototype,"activity",{get:function(){return this.token},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"configure",{get:function(){return this.config},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"result",{get:function(){return this._result.filter(function(t){return!t})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resultValue",{get:function(){return this._resultValue},enumerable:!0,configurable:!0}),t.prototype.start=function(n){return u.__awaiter(this,void 0,void 0,function(){var e=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.instance.run(n).then(function(t){return e.state=h.RunState.complete,e.stateChanged.next(e.state),e._resultValue=t,e._result.next(t),t})];case 1:return[2,t.sent()]}})})},t.prototype.saveState=function(t){this._currState=t},t.prototype.stop=function(){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return this.state=h.RunState.stop,this.stateChanged.next(this.state),[2]})})},t.prototype.pause=function(){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return this.state=h.RunState.pause,this.stateChanged.next(this.state),[2]})})},t.classAnnations={name:"ActivityRunner",params:{constructor:["token","config","instance"],start:["data"],saveState:["state"],stop:[],pause:[]}},u.__decorate([l.Inject(l.ContainerToken),u.__metadata("design:type",Object)],t.prototype,"container",void 0),t=u.__decorate([l.Injectable(h.ActivityRunnerToken),u.__metadata("design:paramtypes",[Object,Object,Object])],t)}();e.ActivityRunner=n});e(A);A.ActivityRunner;var g=n(function(t,e){function n(t){return t instanceof A.ActivityRunner}Object.defineProperty(e,"__esModule",{value:!0}),e.isActivityRunner=n,e.isActivityType=function(t,e){return void 0===e&&(e=!0),!(!t||n(t)||l.isString(t)||!l.isToken(t)&&(!l.isMetadataObject(t)||e&&!(t.activity||t.task||t.bootstrap)))}});e(g);g.isActivityRunner,g.isActivityType;var k=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(o){function t(){return null!==o&&o.apply(this,arguments)||this}return u.__extends(t,o),t.prototype.build=function(t,e,n){return o.prototype.build.call(this,t,e,n)},t.prototype.buildByConfig=function(t,e){return o.prototype.buildByConfig.call(this,t,e)},t.prototype.createInstance=function(n,r,i){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return l.isString(n)&&(n=this.traslateStrToken(n)),[4,o.prototype.createInstance.call(this,n,r,i)];case 1:return(e=t.sent())?(l.isString(i)&&(e.id=i),l.isFunction(e.onActivityInit)?[4,Promise.resolve(e.onActivityInit(r))]:[3,3]):[2,null];case 2:t.sent(),t.label=3;case 3:return[2,e]}})})},t.prototype.buildStrategy=function(e,n,t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return n.name&&(e.name=n.name),e.config=n,[2,e]})})},t.prototype.getDefaultAcitvity=function(){return y.Activity},t.prototype.getType=function(t){var e=t.activity||t.task||t.token||t.type;return l.isString(e)&&(e=this.traslateStrToken(e)),e},t.prototype.getDecorator=function(){return f.Task.toString()},t.prototype.resolveToken=function(t,e){var n=this.container.resolve(t);return n.id=e,n},t.prototype.traslateStrToken=function(t){var e=new p.InjectAcitityToken(t);return this.container.has(e)?e:t},t.prototype.toExpression=function(e,n){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){switch(t.label){case 0:return g.isActivityType(e)?[4,this.buildByConfig(e,n.id)]:[3,2];case 1:return[2,t.sent()];case 2:return[2,e]}})})},t.prototype.toActivity=function(i,o,a,c,s){return u.__awaiter(this,void 0,void 0,function(){var e,n,r;return u.__generator(this,function(t){switch(t.label){case 0:return g.isActivityType(i,!s)?s?[4,this.buildByConfig(l.isToken(i)?i:s(i),o.id)]:[3,2]:[3,5];case 1:return e=t.sent(),[3,4];case 2:return[4,this.buildByConfig(i,o.id)];case 3:e=t.sent(),t.label=4;case 4:return[3,6];case 5:e=i,t.label=6;case 6:return a(e)?[2,e]:l.isString(e)?(n=e,[3,9]):[3,7];case 7:return[4,o.context.exec(o,e)];case 8:n=t.sent(),t.label=9;case 9:return r=c(n),s&&(r=s(r)),r?[4,this.buildByConfig(r,o.id)]:[3,11];case 10:return e=t.sent(),[3,12];case 11:e=null,t.label=12;case 12:return[2,e]}})})},t.classAnnations={name:"ActivityBuilder",params:{build:["token","config","data"],buildByConfig:["activity","data"],createInstance:["token","config","uuid"],buildStrategy:["activity","config","container"],getDefaultAcitvity:[],getType:["config"],getDecorator:[],resolveToken:["token","uuid"],traslateStrToken:["token"],toExpression:["exptype","target"],toActivity:["exptype","target","isRightActivity","toConfig","valify"]}},t=u.__decorate([l.Injectable(_.ActivityBuilderToken)],t)}(o.AnnotationBuilder);e.ActivityBuilder=n});e(k);k.ActivityBuilder;var b=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return u.__extends(e,t),e.classAnnations={name:"ExpressionActivity",params:{}},e=u.__decorate([f.Task],e)}(y.Activity);e.ExpressionActivity=n;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return u.__extends(e,t),e.classAnnations={name:"AssignActivity",params:{}},e=u.__decorate([f.Task],e)}(y.Activity);e.AssignActivity=r});e(b);b.ExpressionActivity,b.AssignActivity;var w=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.getContainer=function(){return this.container},t.prototype.getRootPath=function(){return(this.getContainer().get(o.AppConfigureToken)||{}).baseURL||"."},t.prototype.getEnvArgs=function(){return{}},t.prototype.to=function(t,e){return l.isFunction(t)?l.isClass(t)?t:t(this,e):t},t.prototype.exec=function(t,e,n){return l.isFunction(e)?e(t,n):l.isPromise(e)?e:e instanceof y.Activity?e.run(n,t):e instanceof A.ActivityRunner?e.start(n):Promise.resolve(e)},t.prototype.isTask=function(t){return l.hasOwnClassMetadata(f.Task,t)},t.classAnnations={name:"Context",params:{constructor:[],getContainer:[],getRootPath:[],getEnvArgs:[],to:["target","config"],exec:["target","expression","data"],isTask:["task"]}},u.__decorate([l.Inject(l.ContainerToken),u.__metadata("design:type",Object)],t.prototype,"container",void 0),u.__decorate([l.Inject(_.ActivityBuilderToken),u.__metadata("design:type",k.ActivityBuilder)],t.prototype,"builder",void 0),t=u.__decorate([l.Singleton(v.ContextToken),u.__metadata("design:paramtypes",[])],t)}();e.Context=n});e(w);w.Context;var T=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.UUIDToken=new l.InjectToken("uuid_factory");var n=function(){function t(){}return t.prototype.generate=function(){return this.randomS4()+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+"-"+this.randomS4()+this.randomS4()+this.randomS4()},t.prototype.randomS4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},t.classAnnations={name:"RandomUUIDFactory",params:{constructor:[],generate:[],randomS4:[]}},t=u.__decorate([l.Singleton(e.UUIDToken),u.__metadata("design:paramtypes",[])],t)}();e.RandomUUIDFactory=n});e(T);T.UUIDToken,T.RandomUUIDFactory;var m=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(_,e),u.__exportStar(k,e),u.__exportStar(p,e),u.__exportStar(y,e),u.__exportStar(b,e),u.__exportStar(g,e),u.__exportStar(f,e),u.__exportStar(v,e),u.__exportStar(w,e),u.__exportStar(h,e),u.__exportStar(A,e),u.__exportStar(T,e)});e(m);var x=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DelayActivityToken=new m.InjectAcitityToken("delay");var n=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return u.__extends(t,r),t.prototype.onActivityInit=function(n){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,r.prototype.onActivityInit.call(this,n)];case 1:return t.sent(),[4,(e=this).toExpression(n.delay,this)];case 2:return e.delay=t.sent(),[2]}})})},t.prototype.run=function(i){return u.__awaiter(this,void 0,void 0,function(){var e,n,r;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.delay,i)];case 1:return e=t.sent(),n=new l.Defer,r=setTimeout(function(){n.resolve(i),clearTimeout(r)},e),[4,n.promise];case 2:return[2,t.sent()]}})})},t.classAnnations={name:"DelayActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.DelayActivityToken)],t)}(m.Activity);e.DelayActivity=n});e(x);x.DelayActivityToken,x.DelayActivity;var I=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.IntervalActivityToken=new m.InjectAcitityToken("interval");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return u.__extends(t,i),t.prototype.onActivityInit=function(r){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).toExpression(r.interval)];case 2:return e.interval=t.sent(),[4,(n=this).buildActivity(r.body)];case 3:return n.body=t.sent(),[2]}})})},t.prototype.run=function(i){return u.__awaiter(this,void 0,void 0,function(){var e,n,r=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.interval,i)];case 1:return e=t.sent(),n=i,setInterval(function(){r.body.run(n)},e),[2,i]}})})},t.classAnnations={name:"IntervalActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.IntervalActivityToken)],t)}(m.Activity);e.IntervalActivity=n});e(I);I.IntervalActivityToken,I.IntervalActivity;var S=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.DoWhileActivityToken=new m.InjectAcitityToken("dowhile");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return u.__extends(t,i),t.prototype.onActivityInit=function(r){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).buildActivity(r.do)];case 2:return e.body=t.sent(),[4,(n=this).toExpression(r.while)];case 3:return n.condition=t.sent(),[2]}})})},t.prototype.run=function(r){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.body.run(r)];case 1:return e=t.sent(),[4,this.context.exec(this,this.condition,e)];case 2:n=t.sent(),t.label=3;case 3:return n?[4,this.body.run(e||r)]:[3,6];case 4:return e=t.sent(),[4,this.context.exec(this,this.condition,e)];case 5:return n=t.sent(),[3,3];case 6:return[2,e]}})})},t.classAnnations={name:"DoWhileActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.DoWhileActivityToken)],t)}(m.Activity);e.DoWhileActivity=n});e(S);S.DoWhileActivityToken,S.DoWhileActivity;var j=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.IfActivityToken=new m.InjectAcitityToken("if");var n=function(o){function t(){return null!==o&&o.apply(this,arguments)||this}return u.__extends(t,o),t.prototype.onActivityInit=function(i){return u.__awaiter(this,void 0,void 0,function(){var e,n,r;return u.__generator(this,function(t){switch(t.label){case 0:return[4,o.prototype.onActivityInit.call(this,i)];case 1:return t.sent(),[4,(e=this).buildActivity(i.ifBody)];case 2:return e.ifBody=t.sent(),[4,(n=this).toExpression(i.if)];case 3:return n.condition=t.sent(),i.elseBody?[4,(r=this).buildActivity(i.elseBody)]:[3,5];case 4:r.elseBody=t.sent(),t.label=5;case 5:return[2]}})})},t.prototype.run=function(e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.condition,e)];case 1:return t.sent()?[2,this.execIf(e)]:this.elseBody?[2,this.execElse(e)]:[2,Promise.resolve(e)]}})})},t.prototype.execIf=function(t){return this.ifBody.run(t)},t.prototype.execElse=function(t){return this.elseBody.run(t)},t.classAnnations={name:"IfActivity",params:{onActivityInit:["config"],run:["data"],execIf:["data"],execElse:["data"]}},t=u.__decorate([m.Task(e.IfActivityToken)],t)}(m.Activity);e.IfActivity=n});e(j);j.IfActivityToken,j.IfActivity;var M=n(function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.InvokeActivityToken=new m.InjectAcitityToken("invoke");var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return u.__extends(e,t),e.prototype.run=function(e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2,this.context.getContainer().invoke(this.targetType,this.target,this.args,{data:e})]})})},e.classAnnations={name:"InvokeActivity",params:{run:["data"]}},e=u.__decorate([m.Task(n.InvokeActivityToken)],e)}(m.Activity);n.InvokeActivity=e});e(M);M.InvokeActivityToken,M.InvokeActivity;var C=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ParallelActivityToken=new m.InjectAcitityToken("parallel");var n=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.activites=[],t}var o;return u.__extends(t,n),(o=t).prototype.onActivityInit=function(e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){switch(t.label){case 0:return[4,n.prototype.onActivityInit.call(this,e)];case 1:return t.sent(),e.parallel&&e.parallel.length?[4,this.buildChildren(this,e.parallel)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.buildChildren=function(n,i){return u.__awaiter(this,void 0,void 0,function(){var e,r=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,Promise.all(i.map(function(n){return u.__awaiter(r,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n)];case 1:return(e=t.sent())?e instanceof o&&!l.isToken(n)&&n.parallel&&n.parallel.length?[4,e.buildChildren(e,n.parallel)]:[3,3]:[2,null];case 2:t.sent(),t.label=3;case 3:return[2,e]}})})}))];case 1:return e=t.sent(),n.activites=e,[2,n]}})})},t.prototype.run=function(n,r){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.before(n,r)];case 1:return e=t.sent(),[4,this.execute(e,r)];case 2:return e=t.sent(),[4,this.after(e,r)];case 3:return[2,e=t.sent()]}})})},t.prototype.before=function(e,t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2,e]})})},t.prototype.execute=function(e,t){return Promise.all(this.activites.map(function(t){return t.run(e)}))},t.prototype.after=function(e,t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2,e]})})},t.classAnnations={name:"ParallelActivity",params:{onActivityInit:["config"],buildChildren:["activity","configs"],run:["data","execute"],before:["data","execute"],execute:["data","execute"],after:["data","execute"]}},t=o=u.__decorate([m.Task(e.ParallelActivityToken)],t)}(m.Activity);e.ParallelActivity=n});e(C);C.ParallelActivityToken,C.ParallelActivity;var B=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SequenceActivityToken=new m.InjectAcitityToken("sequence");var n=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}var o;return u.__extends(t,n),(o=t).prototype.onActivityInit=function(e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){switch(t.label){case 0:return this.activites=this.activites||[],[4,n.prototype.onActivityInit.call(this,e)];case 1:return t.sent(),e.sequence&&e.sequence.length?[4,this.buildChildren(this,e.sequence)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})},t.prototype.buildChildren=function(n,i){return u.__awaiter(this,void 0,void 0,function(){var e,r=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,Promise.all(i.map(function(n){return u.__awaiter(r,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n)];case 1:return(e=t.sent())?e instanceof o&&!l.isToken(n)&&n.sequence&&n.sequence.length?[4,e.buildChildren(e,n.sequence)]:[3,3]:[2,null];case 2:t.sent(),t.label=3;case 3:return[2,e]}})})}))];case 1:return e=t.sent(),n.activites=e,[2,n]}})})},t.prototype.run=function(n,r){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.before(n,r)];case 1:return e=t.sent(),[4,this.execute(e,r)];case 2:return e=t.sent(),[4,this.after(e,r)];case 3:return[2,e=t.sent()]}})})},t.prototype.before=function(e,t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2,e]})})},t.prototype.execute=function(t,e){var n=Promise.resolve(t);return this.activites.forEach(function(e){n=n.then(function(t){return e.run(t)})}),n},t.prototype.after=function(e,t){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){return[2,e]})})},t.classAnnations={name:"SequenceActivity",params:{onActivityInit:["config"],buildChildren:["activity","configs"],run:["data","execute"],before:["data","execute"],execute:["data","execute"],after:["data","execute"]}},t=o=u.__decorate([m.Task(e.SequenceActivityToken)],t)}(m.Activity);e.SequenceActivity=n});e(B);B.SequenceActivityToken,B.SequenceActivity;var P=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.SwitchActivityToken=new m.InjectAcitityToken("switch");var n=function(o){function t(){var t=null!==o&&o.apply(this,arguments)||this;return t.cases=new l.MapSet,t}return u.__extends(t,o),t.prototype.onActivityInit=function(i){return u.__awaiter(this,void 0,void 0,function(){var e,n,r=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,o.prototype.onActivityInit.call(this,i)];case 1:return t.sent(),[4,(e=this).toExpression(i.expression)];case 2:return e.expression=t.sent(),i.cases&&i.cases.length?[4,Promise.all(i.cases.map(function(n){return u.__awaiter(r,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.buildActivity(n.value)];case 1:return e=t.sent(),this.cases.set(n.key,e),[2,e]}})})}))]:[3,4];case 3:t.sent(),t.label=4;case 4:return i.defaultBody?[4,(n=this).buildActivity(i.defaultBody)]:[3,6];case 5:n.defaultBody=t.sent(),t.label=6;case 6:return[2]}})})},t.prototype.run=function(n){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.expression,n)];case 1:return e=t.sent(),!l.isUndefined(e)&&this.cases.has(e)?[2,this.cases.get(e).run(n)]:this.defaultBody?[2,this.defaultBody.run(n)]:[2,Promise.resolve(n)]}})})},t.classAnnations={name:"SwitchActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.SwitchActivityToken)],t)}(m.Activity);e.SwitchActivity=n});e(P);P.SwitchActivityToken,P.SwitchActivity;var O=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.ThrowActivityToken=new m.InjectAcitityToken("throw");var n=function(r){function t(){return null!==r&&r.apply(this,arguments)||this}return u.__extends(t,r),t.prototype.onActivityInit=function(n){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,r.prototype.onActivityInit.call(this,n)];case 1:return t.sent(),[4,(e=this).toExpression(n.exception)];case 2:return e.exception=t.sent(),[2]}})})},t.prototype.run=function(e){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.exception,e)];case 1:throw t.sent()}})})},t.classAnnations={name:"ThrowActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.ThrowActivityToken)],t)}(m.Activity);e.ThrowActivity=n});e(O);O.ThrowActivityToken,O.ThrowActivity;var D=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.TryCatchActivityToken=new m.InjectAcitityToken("trycatch");var n=function(a){function t(){var t=null!==a&&a.apply(this,arguments)||this;return t.catchs=[],t}return u.__extends(t,a),t.prototype.onActivityInit=function(o){return u.__awaiter(this,void 0,void 0,function(){var e,n,r,i=this;return u.__generator(this,function(t){switch(t.label){case 0:return[4,a.prototype.onActivityInit.call(this,o)];case 1:return t.sent(),[4,(e=this).buildActivity(o.try)];case 2:return e.try=t.sent(),o.catchs&&o.catchs.length?[4,Promise.all(o.catchs.map(function(t){return i.buildActivity(t)}))]:[3,4];case 3:n=t.sent(),this.catchs=n,t.label=4;case 4:return o.finally?[4,(r=this).buildActivity(o.finally)]:[3,6];case 5:r.finally=t.sent(),t.label=6;case 6:return[2]}})})},t.prototype.run=function(r){return u.__awaiter(this,void 0,void 0,function(){var n,e=this;return u.__generator(this,function(t){try{n=this.try.run(r),this.catchs.forEach(function(e){n=n.catch(function(t){return e.run(t)})}),this.finally&&n.then(function(t){return e.finally.run(t)})}catch(t){n=Promise.resolve(r),this.finally&&n.then(function(t){return e.finally.run(t)})}return[2,n]})})},t.classAnnations={name:"TryCatchActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.TryCatchActivityToken)],t)}(y.Activity);e.TryCatchActivity=n});e(D);D.TryCatchActivityToken,D.TryCatchActivity;var R=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WhileActivityToken=new m.InjectAcitityToken("while");var n=function(i){function t(){return null!==i&&i.apply(this,arguments)||this}return u.__extends(t,i),t.prototype.onActivityInit=function(r){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return[4,i.prototype.onActivityInit.call(this,r)];case 1:return t.sent(),[4,(e=this).buildActivity(r.body)];case 2:return e.body=t.sent(),[4,(n=this).toExpression(r.while)];case 3:return n.condition=t.sent(),[2]}})})},t.prototype.run=function(r){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.context.exec(this,this.condition,r)];case 1:e=t.sent(),t.label=2;case 2:return e?[4,this.body.run(n||r)]:[3,5];case 3:return n=t.sent(),[4,this.context.exec(this,this.condition,n)];case 4:return e=t.sent(),[3,2];case 5:return[2,n]}})})},t.classAnnations={name:"WhileActivity",params:{onActivityInit:["config"],run:["data"]}},t=u.__decorate([m.Task(e.WhileActivityToken)],t)}(m.Activity);e.WhileActivity=n});e(R);R.WhileActivityToken,R.WhileActivity;var W=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(x,e),u.__exportStar(I,e),u.__exportStar(S,e),u.__exportStar(j,e),u.__exportStar(M,e),u.__exportStar(C,e),u.__exportStar(B,e),u.__exportStar(P,e),u.__exportStar(O,e),u.__exportStar(D,e),u.__exportStar(R,e)});e(W);var U=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.prototype.beforeRun=function(t){var e=this.getRunner(t.target);if(e)switch(e.saveState(t),e.state){case m.RunState.pause:throw new Error("workflow paused!");case m.RunState.stop:throw new Error("workflow stop!")}},t.prototype.afterRun=function(t){var e=this.getRunner(t.target);if(e)switch(e.saveState(t),e.state){case m.RunState.pause:throw new Error("workflow paused!");case m.RunState.stop:throw new Error("workflow stop!")}},t.prototype.getRunner=function(t){return t instanceof m.Activity&&t.id&&this.container.has(t.id)?this.container.resolve(t.id):null},t.classAnnations={name:"RunAspect",params:{constructor:[],beforeRun:["joinPoint"],afterRun:["joinPoint"],getRunner:["task"]}},u.__decorate([l.Inject(l.ContainerToken),u.__metadata("design:type",Object)],t.prototype,"container",void 0),u.__decorate([i.Before("execution(*.run)"),u.__metadata("design:type",Function),u.__metadata("design:paramtypes",[i.Joinpoint]),u.__metadata("design:returntype",void 0)],t.prototype,"beforeRun",null),u.__decorate([i.AfterReturning("execution(*.run)"),u.__metadata("design:type",Function),u.__metadata("design:paramtypes",[i.Joinpoint]),u.__metadata("design:returntype",void 0)],t.prototype,"afterRun",null),t=u.__decorate([i.Aspect({annotation:m.Task,singleton:!0}),u.__metadata("design:paramtypes",[])],t)}();e.RunAspect=n});e(U);U.RunAspect;var E=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(U,e)});e(E);var q=n(function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.WorkflowMetaAccessorToken=new l.InjectMetaAccessorToken(m.Activity);var e=function(t){function e(){return t.call(this,[m.Workflow.toString(),m.Task.toString()])||this}return u.__extends(e,t),e.classAnnations={name:"WorkflowMetaAccessor",params:{constructor:[]}},e=u.__decorate([l.Injectable(n.WorkflowMetaAccessorToken),u.__metadata("design:paramtypes",[])],e)}(l.MetaAccessor);n.WorkflowMetaAccessor=e});e(q);q.WorkflowMetaAccessorToken,q.WorkflowMetaAccessor;var V=n(function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.WorkflowModuleValidateToken=new l.InjectModuleValidateToken(m.Workflow.toString());var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return u.__extends(e,t),e.prototype.getDecorator=function(){return[m.Workflow.toString(),m.Task.toString()]},e.classAnnations={name:"WorkflowModuleValidate",params:{getDecorator:[]}},e=u.__decorate([l.Singleton(n.WorkflowModuleValidateToken)],e)}(l.BaseModuelValidate);n.WorkflowModuleValidate=e});e(V);V.WorkflowModuleValidateToken,V.WorkflowModuleValidate;var F=n(function(t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.WorkflowModuleInjectorToken=new l.InjectModuleInjectorToken(m.Workflow.toString());var e=function(e){function t(t){return e.call(this,t)||this}return u.__extends(t,e),t.prototype.importModule=function(r,i){return u.__awaiter(this,void 0,void 0,function(){var e,n;return u.__generator(this,function(t){switch(t.label){case 0:return r.register(i),e=this.validate.getMetaConfig(i,r),[4,this.registerConfgureDepds(r,e)];case 1:return t.sent(),n=new o.InjectedModule(i,e,r),r.bindProvider(new o.InjectedModuleToken(i),n),[2,n]}})})},t.classAnnations={name:"WorkflowModuleInjector",params:{constructor:["validate"],importModule:["container","type"]}},t=u.__decorate([l.Injectable(n.WorkflowModuleInjectorToken),u.__param(0,l.Inject(V.WorkflowModuleValidateToken)),u.__metadata("design:paramtypes",[Object])],t)}(o.DIModuleInjector);n.WorkflowModuleInjector=e});e(F);F.WorkflowModuleInjectorToken,F.WorkflowModuleInjector;var L=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.WorkflowBuilderToken=new o.InjectModuleBuilderToken(m.Activity);var n=function(o){function t(){return null!==o&&o.apply(this,arguments)||this}return u.__extends(t,o),t.prototype.bootstrap=function(n,r,i){return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return[4,this.load(n,r)];case 1:return e=t.sent(),i=i||this.createUUID(e.container),[4,o.prototype.bootstrap.call(this,n,e,i)];case 2:return[2,t.sent()]}})})},t.prototype.createUUID=function(t){return t.has(m.UUIDToken)||t.register(m.RandomUUIDFactory),t.get(m.UUIDToken).generate()},t.prototype.getBootTyp=function(t){return t.activity||t.task||o.prototype.getBootType.call(this,t)},t.prototype.getDefaultService=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.resolve.apply(t,[m.ActivityRunnerToken].concat(e))},t.classAnnations={name:"DefaultWorkflowBuilder",params:{bootstrap:["activity","env","workflowId"],createUUID:["container"],getBootTyp:["config"],getDefaultService:["container","providers"]}},t=u.__decorate([l.Singleton(e.WorkflowBuilderToken)],t)}(o.ModuleBuilder);e.DefaultWorkflowBuilder=n});e(L);L.WorkflowBuilderToken,L.DefaultWorkflowBuilder;var J=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(q,e),u.__exportStar(V,e),u.__exportStar(F,e),u.__exportStar(L,e)});e(J);var z=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.container=t}return t.prototype.setup=function(){var t=this.container,e=t.getLifeScope();e.registerDecorator(m.Workflow,l.CoreActions.bindProvider,l.CoreActions.cache,l.CoreActions.componentBeforeInit,l.CoreActions.componentInit,l.CoreActions.componentAfterInit),e.registerDecorator(m.Task,l.CoreActions.bindProvider,l.CoreActions.cache,l.CoreActions.componentBeforeInit,l.CoreActions.componentInit,l.CoreActions.componentAfterInit),t.register(m.ActivityBuilder).register(m.ActivityRunner).register(m.Context).register(E.RunAspect).register(m.Activity).use(W).use(J)},t.classAnnations={name:"CoreModule",params:{constructor:["container"],setup:[]}},t=u.__decorate([l.IocExt("setup"),u.__param(0,l.Inject(l.ContainerToken)),u.__metadata("design:paramtypes",[Object])],t)}();e.CoreModule=n});e(z);z.CoreModule;var K=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){this.baseURL=t}return t.prototype.getContainer=function(){return this.container||(this.container=this.getBuilder().getPools().getDefault()),this.container},t.prototype.getBuilder=function(){return this.builder||(this.builder=this.createAppBuilder(),this.builder.events.on(o.ApplicationEvents.onRootContainerCreated,function(t){t.register(J.DefaultWorkflowBuilder).register(J.WorkflowModuleValidate).register(J.WorkflowModuleInjector),t.getBuilder().getInjectorChain(t).first(t.resolve(J.WorkflowModuleInjectorToken))}),this.builder.use(i.AopModule).use(a.LogModule).use(z.CoreModule).provider(o.DefaultAnnotationBuilderToken,m.ActivityBuilderToken).provider(o.DefaultServiceToken,m.ActivityRunnerToken).provider(o.DefaultModuleBuilderToken,J.WorkflowBuilderToken)),this.builder},t.prototype.createAppBuilder=function(){return new o.DefaultApplicationBuilder(this.baseURL)},t.prototype.useConfiguration=function(t){return this.getBuilder().useConfiguration(t),this},t.prototype.use=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return(t=this.getBuilder()).use.apply(t,e),this},t.prototype.provider=function(t,e){return this.getBuilder().provider(t,e),this},t.prototype.useLog=function(t){return l.hasClassMetadata(i.Aspect,t)?this.getBuilder().use(t):console.error("logAspect param is not right aspect"),this},t.prototype.getWorkflow=function(t){return this.getContainer().resolve(t)},t.prototype.createActivity=function(i,o){return u.__awaiter(this,void 0,void 0,function(){var e,n,r;return u.__generator(this,function(t){switch(t.label){case 0:return o=o||this.createUUID(),l.isToken(i)?e=i:((e=i||{}).id=o,e.builder=e.builder||J.WorkflowBuilderToken,e.annotationBuilder=e.annotationBuilder||m.ActivityBuilderToken),n=this.getBuilder().getPools().create(),[4,this.getBuilder().bootstrap(e,n,o)];case 1:return r=t.sent(),this.getContainer().bindProvider(o,r),[2,r]}})})},t.prototype.createUUID=function(){var t=this.getContainer();return t.has(m.UUIDToken)||t.register(m.RandomUUIDFactory),t.get(m.UUIDToken).generate()},t.prototype.bootstrap=function(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return u.__awaiter(this,void 0,void 0,function(){var e;return u.__generator(this,function(t){switch(t.label){case 0:return e=1<n.length?{sequence:n,task:W.SequenceActivity}:l.lang.first(n),[4,this.createActivity(e)];case 1:return[2,t.sent()]}})})},t.classAnnations={name:"DefaultTaskContainer",params:{constructor:["baseURL"],getContainer:[],getBuilder:[],createAppBuilder:[],useConfiguration:["config"],use:["modules"],provider:["provide","provider"],useLog:["logAspect"],getWorkflow:["workflowId"],createActivity:["activity","workflowId"],createUUID:[],bootstrap:["activites"]}},t}();e.DefaultTaskContainer=n});e(K);K.DefaultTaskContainer;var $=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.pick=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r={};return t.forEach(function(t){r[t]=e[t]}),r}});e($);$.pick;var G=n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar($,e)});return e(G),e(n(function(t,e){Object.defineProperty(e,"__esModule",{value:!0}),u.__exportStar(c,e),u.__exportStar(K,e),u.__exportStar(J,e),u.__exportStar(G,e),u.__exportStar(m,e),u.__exportStar(E,e),u.__exportStar(W,e),u.__exportStar(z,e)}))});